<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‡πÄ‡∏•‡πà‡∏≤‡∏ô‡∏¥‡∏ó‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡∏†‡∏≤‡∏û</title>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 1rem; background: #f9f9f9; }
    video, canvas, img { width: 100%; max-width: 480px; border-radius: 1rem; margin-bottom: 1rem; }
    button { padding: 0.5rem 1rem; margin: 0.25rem; border-radius: 1rem; border: none; cursor: pointer; }
    .dark-mode { background: #222; color: #fff; }
    #spinner { display: none; }
    .result-box { border: 1px solid #ccc; padding: 1rem; border-radius: 1rem; background: #fff; }
    .dark-mode .result-box { background: #333; color: #fff; }
    .star-rating span { font-size: 1.5rem; cursor: pointer; color: gold; }
  </style>
</head>
<body>
  <h1>‡πÄ‡∏•‡πà‡∏≤‡∏ô‡∏¥‡∏ó‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡∏†‡∏≤‡∏û</h1>
  <video id="video" autoplay playsinline></video>
  <canvas id="canvas" style="display:none;"></canvas>
  <img id="capturedImage" style="display:none;"/>

  <div>
    <button id="capture">üì∏ ‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û</button>
    <button id="retake" style="display:none;">üîÑ ‡∏ñ‡πà‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà</button>
    <button id="switch-camera">üîÅ ‡∏™‡∏•‡∏±‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
    <button id="change-language">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©</button>
    <button id="theme-toggle">üåì ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ò‡∏µ‡∏°</button>
  </div>

  <div id="status"></div>
  <div id="spinner">‚è≥</div>

  <div class="result-box" id="result" style="display:none;">
    <h2>üìñ ‡∏ô‡∏¥‡∏ó‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡∏†‡∏≤‡∏û</h2>
    <p id="resultText"></p>
    <div>
      <button id="play">‚ñ∂Ô∏è ‡∏≠‡πà‡∏≤‡∏ô</button>
      <button id="pause" style="display:none;">‚è∏Ô∏è ‡∏´‡∏¢‡∏∏‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß</button>
      <button id="stop" style="display:none;">‚èπÔ∏è ‡∏´‡∏¢‡∏∏‡∏î</button>
    </div>
    <div>
      <button id="download">‚¨áÔ∏è ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î</button>
      <button id="shareImage">üì§ ‡πÅ‡∏ä‡∏£‡πå‡∏†‡∏≤‡∏û</button>
      <button id="history">üïò ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ô‡∏¥‡∏ó‡∏≤‡∏ô</button>
    </div>
    <div class="star-rating">
      ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô:
      <span data-value="1">‚≠ê</span>
      <span data-value="2">‚≠ê</span>
      <span data-value="3">‚≠ê</span>
      <span data-value="4">‚≠ê</span>
      <span data-value="5">‚≠ê</span>
    </div>
  </div>

  <script>
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const result = document.getElementById("result");
    const resultText = document.getElementById("resultText");
    const captureBtn = document.getElementById("capture");
    const retakeBtn = document.getElementById("retake");
    const playBtn = document.getElementById("play");
    const pauseBtn = document.getElementById("pause");
    const stopBtn = document.getElementById("stop");
    const downloadBtn = document.getElementById("download");
    const shareImageBtn = document.getElementById("shareImage");
    const themeToggle = document.getElementById("theme-toggle");
    const changeLanguageBtn = document.getElementById("change-language");
    const historyBtn = document.getElementById("history");
    const statusDiv = document.getElementById("status");
    const spinner = document.getElementById("spinner");
    const stars = document.querySelectorAll(".star-rating span");
    const capturedImage = document.getElementById("capturedImage");

    let currentFacingMode = "user";
    let currentLanguage = "th";
    const STORY_PROMPT = "‡πÇ‡∏õ‡∏£‡∏î‡πÅ‡∏ï‡πà‡∏á‡∏ô‡∏¥‡∏ó‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡∏†‡∏≤‡∏û‡∏ô‡∏µ‡πâ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏î‡πá‡∏Å‡∏≠‡∏≤‡∏¢‡∏∏ 7 ‡∏Ç‡∏ß‡∏ö ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏©‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏á‡πà‡∏≤‡∏¢ ‡∏™‡∏ô‡∏∏‡∏Å ‡πÅ‡∏•‡∏∞‡∏à‡∏ö‡∏•‡∏á‡∏î‡πâ‡∏ß‡∏¢‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏¥‡∏î"
    const ENGLISH_STORY_PROMPT = "Please create a short children's story (age 7) based on this image in English, with a fun tone and a moral at the end."
    const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-pro-vision:generateContent?key=YOUR_API_KEY"

    let speaking = false;
    let storyHistory = [];

    async function startWebcam(facingMode) {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: facingMode },
          audio: false
        });
        video.srcObject = stream;
        currentFacingMode = facingMode;
        capturedImage.style.display = "none";
        result.style.display = "none";
        retakeBtn.style.display = "none";
      } catch (error) {
        console.error("Camera Error:", error);
        alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ");
      }
    }

    function retakePhoto() {
      capturedImage.style.display = "none";
      video.style.display = "block";
      result.style.display = "none";
      retakeBtn.style.display = "none";
      stopSpeaking();
    }

    function showImage(dataUrl) {
      capturedImage.src = dataUrl;
      capturedImage.style.display = "block";
      video.style.display = "none";
      retakeBtn.style.display = "inline-block";
    }

    function speakText(text) {
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = currentLanguage === "th" ? "th-TH" : "en-US";
      speechSynthesis.speak(utterance);
      speaking = true;
      playBtn.style.display = "none";
      pauseBtn.style.display = "inline-block";
      stopBtn.style.display = "inline-block";
    }

    function pauseSpeaking() {
      if (speaking) {
        speechSynthesis.pause();
        playBtn.style.display = "inline-block";
        pauseBtn.style.display = "none";
      }
    }

    function resumeSpeaking() {
      if (speechSynthesis.paused) {
        speechSynthesis.resume();
        playBtn.style.display = "none";
        pauseBtn.style.display = "inline-block";
      }
    }

    function stopSpeaking() {
      if (speaking) {
        speechSynthesis.cancel();
        speaking = false;
        playBtn.style.display = "inline-block";
        pauseBtn.style.display = "none";
        stopBtn.style.display = "none";
      }
    }

    playBtn.addEventListener("click", () => {
      if (speechSynthesis.paused) {
        resumeSpeaking();
      } else {
        speakText(resultText.textContent);
      }
    });

    pauseBtn.addEventListener("click", pauseSpeaking);
    stopBtn.addEventListener("click", stopSpeaking);

    changeLanguageBtn.addEventListener("click", () => {
      currentLanguage = currentLanguage === 'th' ? 'en' : 'th';
      changeLanguageBtn.textContent = currentLanguage === 'th' ? "‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©" : "Switch to Thai";
    });

    captureBtn.addEventListener("click", async () => {
      spinner.style.display = "inline-block";
      statusDiv.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏†‡∏≤‡∏û‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏≤‡∏ô‡∏¥‡∏ó‡∏≤‡∏ô...";

      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      const imageDataURL = canvas.toDataURL("image/jpeg");

      showImage(imageDataURL);
      const prompt = currentLanguage === 'th' ? STORY_PROMPT : ENGLISH_STORY_PROMPT;
      await generateStory(imageDataURL, prompt);
    });

    async function generateStory(imageDataURL, prompt) {
      const base64Image = imageDataURL.split(',')[1];
      const requestBody = {
        contents: [{
          parts: [
            { text: prompt },
            { inlineData: { mimeType: "image/jpeg", data: base64Image } }
          ]
        }]
      };

      try {
        const response = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(requestBody)
        });

        const data = await response.json();
        const storyText = data?.candidates?.[0]?.content?.parts?.[0]?.text || "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ô‡∏¥‡∏ó‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡∏†‡∏≤‡∏û‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á";

        resultText.textContent = storyText;
        result.style.display = "block";
        spinner.style.display = "none";
        statusDiv.textContent = "";
        storyHistory.push({ image: imageDataURL, story: storyText });
      } catch (error) {
        console.error("Error generating story:", error);
        resultText.textContent = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà";
        spinner.style.display = "none";
        statusDiv.textContent = "";
      }
    }

    retakeBtn.addEventListener("click", retakePhoto);
    document.getElementById("switch-camera").addEventListener("click", () => {
      const newFacingMode = currentFacingMode === "user" ? "environment" : "user";
      startWebcam(newFacingMode);
    });

    themeToggle.addEventListener("click", () => {
      document.body.classList.toggle("dark-mode");
    });

    stars.forEach(star => {
      star.addEventListener("click", () => {
        const rating = star.dataset.value;
        alert(`‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ${rating} ‡∏î‡∏≤‡∏ß!`);
      });
    });

    historyBtn.addEventListener("click", () => {
      const historyText = storyHistory.map((entry, i) => `‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà ${i + 1}:\n${entry.story}`).join("\n\n---\n\n");
      alert(historyText || "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ô‡∏¥‡∏ó‡∏≤‡∏ô");
    });

    shareImageBtn.addEventListener("click", () => {
      html2canvas(result).then(canvas => {
        const link = document.createElement("a");
        link.download = "‡∏ô‡∏¥‡∏ó‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡∏†‡∏≤‡∏û.png";
        link.href = canvas.toDataURL("image/png");
        link.click();
      });
    });

    downloadBtn.addEventListener("click", () => {
      const blob = new Blob([resultText.textContent], { type: "text/plain;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = "‡∏ô‡∏¥‡∏ó‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡∏†‡∏≤‡∏û.txt";
      link.click();
      URL.revokeObjectURL(url);
    });

    startWebcam(currentFacingMode);
  </script>
</body>
</html>
